---
epic: 1
story: 7
title: "CI/CD Pipeline Setup"
status: "Approved"
---

### Story

As a developer, I want an automated CI/CD pipeline, so that builds, tests, and deployments are automated, ensuring consistency and speed.

### Acceptance Criteria

1.  A new GitHub Actions workflow file is created at `.github/workflows/main.yml`.
2.  The workflow is configured to trigger on every `push` to the `main` branch.
3.  The workflow defines separate jobs for the following stages:
    *   **Lint & Test:**
        *   A job that runs the linter for all workspaces (`npm run lint`).
        *   A job that runs all unit tests for all workspaces (`npm test --workspaces --if-present`).
    *   **Build:**
        *   A job that builds the `api` service.
        *   A job that builds the `desktop` application for Windows.
    *   **Deploy:**
        *   A job that deploys the `api` service to Vercel. This job should only run if the "Build" stage succeeds.
        *   A job that creates a new GitHub Release, tags it, and uploads the packaged Windows executable as a release artifact. This job should also only run if the "Build" stage succeeds.
4.  The workflow status (pass/fail) must be required to pass before merging pull requests to the `main` branch.
5.  All sensitive information (e.g., `VERCEL_TOKEN`, `SUPABASE_KEY`) must be stored as encrypted secrets in the GitHub repository settings and accessed securely within the workflow. They must not be hardcoded.

### Dev Notes

*   **Workflow Tool:** We will use GitHub Actions as it is tightly integrated with our source control. [Source: G:\day trader news feed\day-trader-news-feed\docs\architecture\13-development-workflow.md]
*   **Deployment Targets:** The `api` service will be deployed to Vercel, and the `desktop` app will be released on GitHub. [Source: G:\day trader news feed\day-trader-news-feed\docs\architecture\14-deployment-architecture.md]

### Tasks / Subtasks

*   [x] **Task 1: Create Workflow File (AC: 1)**
    *   [x] Create the `main.yml` file in the `.github/workflows` directory.
*   [x] **Task 2: Configure Trigger (AC: 2)**
    *   [x] Add the `on: push: branches: [ main ]` configuration to the workflow.
*   [x] **Task 3: Implement Lint & Test Jobs (AC: 3)**
    *   [x] Create a job that checks out the code and runs `npm run lint`.
    *   [x] Create a job that checks out the code and runs `npm test --workspaces --if-present`.
*   [x] **Task 4: Implement Build Jobs (AC: 3)**
    *   [x] Create a job that builds the `api` service.
    *   [x] Create a job that builds the `desktop` application.
*   [x] **Task 5: Implement Deploy Jobs (AC: 3, 5)**
    *   [x] Create a job that deploys the `api` service to Vercel, using secrets for the API key.
    *   [x] Create a job that creates a GitHub Release and uploads the desktop build artifact.
*   [ ] **Task 6: Configure Branch Protection (AC: 4)**
    *   [ ] In the GitHub repository settings, configure a branch protection rule for the `main` branch to require the CI/CD workflow to pass before merging.

### Testing

*   Testing will be done by pushing a change to a feature branch and creating a pull request to `main`.
*   Validation will involve confirming that the workflow runs, all jobs pass, the `api` is deployed, and a new release is created.

### Dev Agent Record

**Agent Model Used:** James (Full Stack Developer)

**Debug Log References:**
- None encountered during fresh implementation

**Completion Notes:**
- Successfully re-implemented comprehensive CI/CD pipeline workflow file
- Implemented all required jobs: lint, test, build-api, build-desktop, deploy-api, release-desktop
- Configured proper job dependencies and conditional execution
- Used GitHub secrets for sensitive information (VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID, GITHUB_TOKEN)
- Task 6 (branch protection) requires manual configuration in GitHub repository settings

**File List:**
- `.github/workflows/main.yml` - Re-created CI/CD pipeline workflow file
- `docs/stories/1.7.story.md` - Updated story file with fresh task completion status

**Change Log:**
- Re-created GitHub Actions workflow with complete CI/CD pipeline from scratch
- Configured triggers on push to main branch
- Implemented lint and test jobs with proper Node.js setup and job dependencies
- Added build jobs for both API (Ubuntu) and desktop (Windows) applications
- Created deployment jobs for Vercel API deployment and GitHub releases with proper conditionals
- Used proper job dependencies and conditional execution for deploy stage
- All secrets are referenced from GitHub repository secrets

**Status:** Ready for Review
